# Серверные пакеты
О, вы снова здесь. Спасибо, что читаете нас!

В статьях ранее мы разбирали клиентские пакеты, и мультиплеер казался достаточно простым. Начиная с этого момента материал станет сложнее, начинается работа с безопасностью, пакеты придётся защищать. Читайте очень внимательно.

Мы напишем небольшую механику системы изучений, и будем пробовать использовать её пакеты не по назначению. Мы будем постепенно переписывать наши пакеты, чтобы обеспечить достойную безопасность. Так же попробуем выявлять и сразу же кикать нарушителей.

## Что такое серверные пакеты
Серверные пакеты представляют из себя функции, которые отправляются <u>с клиента на сервер</u> и там выполняются, принимают данные при отправке и предоставляют объект клиента, который его отправил. Они являются способом общения клиента с сервером полезны.

## Методы
```js
//отправит с клиента серверный пакет
Network.sendToServer(name, data: object);

//добавит серверный пакет
Network.addServerPacket(name, func: (client: NetworkClient, data: object));

//вернёт список uid игроков на сервере
Network.getConnectedPlayers();

//превратит локальный айди в серверный
Network.localToServerId(id: string | number);
``` 
## Пишем простую систему изучений
### Пишем базу данных и изучения
```js
const learnings = ["construction", "table", "wall", "furnace", "tool"]; 
const playerList = {};
```
### Пишем сохранение данных
Отлично, у нас есть база данных. Давайте теперь напишем [сохранение данных](../storage/saving-basics) об изучениях наших игроков.
```js
Saver.addSavesScope("scope.example.learnings", 
    function read(scope) {
        return scope ? scope : {} //если мы сохраняли раньше данные, читаем их, иначе поставляем пустой объект
    },
    function save() {
        return playerList || {}; //записываем в scope наш объект playerList если нет ошибок, иначе пустой объект
    }
);
```
### Пишем отправку данных о изучениях игрока клиенту
Напишем клиентский пакет, который будет отправлять данные об изучениях с сервера клиенту и записывать их для него. Не забывайте, что значения в переменных на клиенте и на сервере не связаны. 

Поскольку data это объект, и массив это объект, мы будем отправлять сразу массив.
```ts
Network.addClientPacket("packet.example.sync_learnings", (data) => {
    playerList[Player.getLocal()] = data; //получили айди игрока на клиенте и записали пришедшие данные на клиенте.
});
```
:::info Почему бы просто не отправить игроку данные о изучениях всех игроков?

Игроку не нужно знать, какие изучения есть у других игроков в данном случае. Не отправляйте те данные, которые не пригодятся. 

:::

Напишем отправку данных игроку при входе.
```js
Callback.addCallback("ServerPlayerLoaded", (playerUid) => {
    if(!(playerUid in playerList)) {
        playerList[playerUid] = [];
    }
    const client = Network.getClientForPlayer(playerUid);
    if(client != null) {
        client.send("packet.example.sync_learnings", playerList[playerUid]);
    }
});
```
### Пишем пакет для выдачи изучения "tool"
Автор ушёл спать :D