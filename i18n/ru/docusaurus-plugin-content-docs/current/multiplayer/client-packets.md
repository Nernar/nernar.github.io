# Клиентские пакеты
<!-- Кажется, мы снова встретились! Добро пожаловать клиент, рассказ будет интересным. -->
Клиентские пакеты, это одна из вещей, без которых не обходится практически ни один магический мод.

В этой статье мы разберёмся, для чего нужны клиентские пакеты, как их использовать и рассмотрим применение на практическом примере.

<!-- Жил был сервер, и всё у него было спокойно. Он, как обычно управлял миром, сменял день да ночь, блоки ставил как хотел. Он не ждал гостей и был одинок, это было его проклятием. В один чудесный день произошло чудо, он встретил клиентов. Но грусть не покидала его, он не мог с ними общаться, хоть и очень хотел. Он изобрёл пакеты, и подумал, вдруг это поможет, вдруг они смогут поговорить! Но клиенты неправильно поняли его замысел. Они его боялись, на улице шёл дождь, капли спускались с старых деревянных крыш деревенских домов. Ближе к ночи грянул гром, клиенты забились в страхе. Они не видели сервер, они боялись его. Но нашёлся смельчак, который решил, что хочет пообщаться с сервером, вдруг все слухи неоправданы, вдруг сервер друг. Вышел он с утра на улицу, позвал сервер, а потом к нему пришёл пакет... -->

## Что такое клиентские пакеты
Клиентские пакеты представляют из себя функции, которые отправляются <u>с сервера на клиент</u> и там выполняются, принимают данные при отправке. Они являются способом общения сервера с игроками и очень полезны. 

```mermaid
flowchart TB
Сервер-->|клиентский пакет|Клиент
```

Чтобы отправить пакет нам нужно получить объект клиента. На клиент всегда отправляются <u> только клиентские пакеты </u>.
## Методы
Давайте начнём с методов:
```ts
Network.getClientForPlayer(айди игрока); //получили объект клиента конкретного игрока
Network.getConnectedClients(); //получили объекты клиентов всех игроков

Network.addClientPacket(name, func: (data: object) => void); //добавит клиентский пакет
<NetworkClient>.send(name, data: object); //отправит на клиент пакет с сервера
<NetworkClient>.sendMessage(text); //отправит клиенту текст в чат
<NetworkClient>.disconnect(); //исключит игрока из мира, используйте с осторожностью
```
Мы бы могли разобрать клиентские пакеты на основе примера банальной отправки текста в чат, но давайте будем креативнее! Помните, мы писали [анимацию траты денег](../ui/animation), давайте применим её. Мы будем вызывать её с числом, которое будет являться новым уровнем опыта, которое получил игрок.
## Создание пакета
Наш пакет будет запускать на клиенте анимацию с текстом, приходящим из данных пакета. В нашем примере мы применим TypeScript, но лишь для демонстрации приходящих данных.
```ts
Network.addClientPacket("packet.example.start_animation", (data: { text: string }) => {
    if(!data.text) {
        return; //если мы не получили данные, анимация не появится
    }
    animator.init(data.text); //запускаем анимацию
});
```
## Применение пакета
Отправим наш пакет с сервера на клиент по имени пакета и передадим данные об уровне в качестве текста для анимации.
```js
Callback.addCallback("ExpLevelAdd", (level, playerUid) => {
    const client = Network.getClientForPlayer(playerUid); //получили объект клиента в серверном калбеке.
    if(client != null) {
        client.send("packet.example.start_animation", { text: level }); //отправили данные по имени пакета полученному клиенту
    }
});
```
:::note Почему мы просто не запустим анимацию в серверном калбеке?
Дело в том, что тогда её не увидит игрок, у которого обновился уровень, ведь мы запустим её не на клиенте, где происходит вся работа с визуальной частью, а на сервере, где просто произошли вычисления.
:::

:::warning Всегда проверяйте, что объект клиента не равен null

Это позволит избежать редких ошибок.

:::