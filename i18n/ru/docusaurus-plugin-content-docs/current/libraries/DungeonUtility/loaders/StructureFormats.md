---
title: Форматы структур
---

Формат структуры - это способ чтения/записи структуры из/в файл

| Формат            | Поддержка BlockState | Поддержка дополнительного блока | Поддержка CompountNBT | Актуаленный формат? |
|-------------------|----------------------|---------------------------------|-----------------------|---------------------|
| DungeonUtility_V2 | +                    | +                               | +                     | +                   |
| DungeonUtility    | +                    | +                               | +                     | +                   |
| DungeonCore       | +                    | +                               | -                     | -                   |
| Structures        | -                    | -                               | -                     | +                   |
| DungeonUtility    | -                    | -                               | -                     | -                   |
| DungeonAPI        | -                    | -                               | -                     | -                   |
| DungeonAPI_V2     | -                    | -                               | -                     | -                   |

## Зачем существуют различные форматы структур?

Dungeon Utility изначально писался как часть модификации Ancient Wonders/Dungeon craft.
В случае Ancient wonders, данный мод имел 3 различные библиотеки для структур, что было весьма не красиво с точки зрения истеки и поддержки мода.
В случае Dungeon craft, мод всегда использовал только одну библиотеку структур, они использовали разные форматы структур, переход был пусть и простым делом, но в один момент при конвертации форматов произошла ошибка, которая была замечена уже после.

DungeonUtility предлагает быстрый переход с разных библиотек, без проблем с форматом структур!
Примером данного перехода является мод Aether 2 BE, Ancient wonders

## Какой формат лучше использовать?

Формат DungeonUtility - является форматом, **который используется везде по умолчанию**, имеет один жирный минус, большой вес файла.

Формат DungeonUtility_V2 - является новым форматом, который имеет достаточно компакнтый размер, при этом обладает неплохой скоростью загрузки.
Особенностью данного формата являются: что он [бинарный файл](https://en.wikipedia.org/wiki/Binary_file), хорошая безопасноть - иногда происходит повреждение части информации на носителе(увы и ах от этого не кто не застрохован) в случае если часть файла все-же повредилась, есть шанс что хотя-бы половина структуры загрузиться нормально.
Также в формат была заложена такая структура из которой его легко поддерживать и развивать дальше!

Исходя из выше сказаного рекомендую использовать формат DungeonUtility_V2, об устройстве формата можете почитать внизу(не требуется для обычных пользователей библиотеки)

## Спецификация формата DungeonUtility_V2

### Типы данных которые используются

| Тип   | Размер |
|-------|--------|
| byte  | 1      |
| short | 2      |
| int   | 4      |

## Структура файла DungeonUtility_V2

Самый первый byte - версия формата

| Версии   |
|----------|
| -128     |

### Версия DungeonUtility_V2 -128

После версии индут заголовки зоны
Зоны - это некоторое количесва байтов, которое определяется в заголовке зоны
Заголовок зоны - содержат: byte, int. byte - тут это id зоны, int - место где зона заканчивается, в случае не поддержки зоны, чтение зоны пропускается! В случае повреждения int - шансов на чтение файла нет, к счастью это очень маленькая часть файла, шанс на повреждение маленький.

| Зоны | Имя          | Предназначение                       | Приоритет чтения |
|------|--------------|--------------------------------------|------------------|
| -1   | EMPTY        | Скипующая зона                       | 0                |
| -    | MAP          | Хранение информации по байту         | -                |
| 0    | DESCRIPTION  | Описание                             | 10               |
| 1    | STATES       | Описание блоков которые используются | 5                |
| 2    | PLANE_BLOCKS | Разрез структуры                     | -5               |

Чем больше приоритет, чем раньше читается зона

### EMPTY

Зона которая скипает чтение информации внутри себя, может использоваться, в случае повреждения байта, отвечающего за id зоны, также может использовать в случае не поддержки зоны

### MAP

Абстракнтая зона, представляющая собой своего рода HashMap.
Первый byte количество полей, дальше идут поля, каждое поле представляет собой: два byte, первый котороый хранит тип информации, второй байт используется как ключ, по которому, дальше количество байтов и значение зависят от типа

| Тип | Имя    | Размер                                                                |
|-----|--------|-----------------------------------------------------------------------|
| -1  | EMPTY  | Не имеет                                                              |
| 0   | BYTE   | 1                                                                     |
| 1   | SHORT  | 2                                                                     |
| 2   | INT    | 4                                                                     |
| 3   | STRING | 2 байта(short) + плюс прочитанный short  + минимальное значение short |

#### Чтения строки

Читается short, прибавляется минимальное значение short, получаем последовательность байтов строки

### DESCRIPTION

Наследуется от зоны MAP

| Ключ | Имя      |
|------|----------|
| 1    | X_OFFSET |
| 2    | Y_OFFSET |

### STATES

Содержит описание стейтов
Перый байт, тип данных, который используется для обозначения состояния блока(1 - byte, 2 - short), данный байт очень важен для чтения и используется в PLANE_BLOCKS, дальше этот параметр будет называться как **id состояния**!
Следующие 2 байта(short) количетсво состояний

Описания состояния: первые байты **id состояния** дальше идет 3 байта, которые обозначают boolean, есть-ли у блока state, есть-ли у блока extra, есть-ли у tag
Первым читается state, если он есть, вторыи extra, затем tag
Способ записи BlockState, если id блока больше 8000, то первый байт 1 иначе 0, если равен 1 то дальше идет текстовое id блока, если нет то short id блока, после идет BlockState в виде json
tag также записывается в виде строки

### PLANE_BLOCKS

Представляет собой двух мерный массив **id состояний**!
Первый short - это позиция разреза по координате z
второй и третий short - размеры двух мерного массива

Двух мерный массив содержит **id состояния**, каждая позиция в массиве это кордината блока в структурк, также необходимо вычесть X_OFFSET и Y_OFFSET из DESCRIPTION
